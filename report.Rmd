---
documentclass: report
link-citations: true
urlcolor: blue
bibliography: references.bib
linestretch: 1.5
fontsize: 12pt
output:
  bookdown::pdf_document2:
    toc: true
    toc_depth: 3
    includes:
      in_header: preamble.tex
    extra_dependencies: ["mathptmx"]
title: |
  | Assignment 29
  | Statistical Analysis of Grit Scale Data  \vspace{1cm}
  | ![](figures/sigillum-lmu.png){width=3cm} \vspace{1cm}
  | ![](figures/aueb.jpg){width=9cm}         \vspace{1cm}
subtitle: |
  | Submitted to the Department of Statistics
  | of the Athens University of Economics and Business
author: |
  | By
  | Maximilian Schneider
date: "`r format(Sys.time(), '%d.%m.%Y')`"
abstract: |
  Lorem ipsum dolor sit amet, consectetur adipiscing elit.
  Integer fringilla interdum magna, at sodales ante hendrerit in.
  Ut mauris justo, sodales sed posuere id, ultrices ut ante.
  In auctor tellus nulla, nec efficitur tellus finibus id.
  Vivamus at condimentum sapien, a sodales erat.
  Nulla nec neque eu purus consequat vestibulum.
  Vestibulum placerat congue porttitor.
  In hac habitasse platea dictumst.
  In hac habitasse platea dictumst.
  Sed consectetur a quam a posuere.
  Ut elit leo, lobortis sit amet risus vel, ultrices fringilla nisl.
  Aliquam ut leo mauris.
  Suspendisse neque tellus, aliquet ac dignissim vitae, gravida sit amet elit.
  Ut eget turpis ac sem aliquet scelerisque.
  Phasellus in maximus est.
---

<style>
body {
text-align: justify}
.main-container {
  max-width: 1000px;
  margin-left: auto;
  margin-right: auto;
}
</style>

# Introduction

```{r setup, include=FALSE}
# rmarkdown settings
knitr::opts_chunk$set(fig.align = "center", out.width = '80%',
                      include = FALSE, echo = FALSE, cache = FALSE, eval=FALSE)

# packages
library(data.table)
library(purrr)
library(magrittr)
library(ggplot2); theme_set(theme_bw())

# data
source("R/prepare-data.R")

# functions

# plots
```

As part of the Data Analysis course of the Athens University of Economics and Business a dataset is to be analyzed.
This report describes the applied methods and corresponding findings.
The assigned dataset "grit scale data" originates from the study "Development and Validation of the Short Grit Scale (Grit-S)" [@duckworth2009development].

# Analysis of online personality test

## Data

### Overview

```{r data-structure}
str(dt_bigf)
summary(dt_bigf)
```

```{r correlation}
cor(dt_bigf[, -c("hits", "misses", "trials")][, .SD, .SDcols = is.numeric],
    use = "pairwise.complete.obs") %>%
  round(1) %>%
  ggcorrplot::ggcorrplot(method = "circle", type = "lower")
```

### Eloquence score

```{r plot-eloquence, include=TRUE}
dnorm_args <- function(x) list(mean = mean(x, na.rm = TRUE), sd = sd(x, na.rm = TRUE))

ggplot(dt_bigf, aes(x = eloquence)) +
  geom_histogram(aes(y = ..density..), breaks = seq(0, 1, length = 200),
                 color = "black", fill = "white") +
  geom_density() +
  geom_function(fun = dnorm, args = dnorm_args(dt_bigf$eloquence), color = "red")

ggplot(dt_bigf, aes(x = eloquence)) +
  stat_ecdf() +
  geom_function(fun = pnorm, args = dnorm_args(dt_bigf$eloquence), color = "red")
```

### Openness score

```{r plot-openness, include=TRUE, warning=FALSE}
ggplot(dt_bigf, aes(x = openness)) +
  geom_histogram(aes(y = ..density..), breaks = seq(0, 1, length = 200),
                 color = "black", fill = "white") +
  geom_density() +
  geom_function(fun = dnorm, args = dnorm_args(dt_bigf$openness), color = "red")

ggplot(dt_bigf, aes(x = openness)) +
  stat_ecdf() +
  geom_function(fun = pnorm, args = dnorm_args(dt_bigf$openness), color = "red")

ggplot(dt_bigf, aes(sample = openness)) +
  geom_qq() +
  geom_qq_line()
```

### Survey duration

```{r time-spent}
dt_bigf[, summary(.SD), .SDcols = patterns("elapse$")]
```

```{r plot-time, include=TRUE}
# there are some extreme values
ggplot(dt_bigf[introelapse < 3000,], aes(x = introelapse)) +
  geom_histogram(aes(y = ..density..), breaks = seq(1, 3000, length = 100),
                 color = "black", fill = "white")

dt_bigf[, lapply(.SD, function(x) {
            ind_long <- x > 3000
            list(c(sum(!ind_long), mean(x[!ind_long])), c(sum(ind_long), mean(x[ind_long])))
          })
        , .SDcols = patterns("elapse$")]
```

## Pairwise comparisons

```{r todos}
# TODO: scatter plots with openness
# TODO: correlation plots - co-linearity is a problem!
# TODO: contingency tables
# TODO: VCL to one variable
```

<!-- continuous -->

### Openness and eloquence

```{r openness-eloquence, include=TRUE}
ggplot(dt_bigf[!is.na(engnat)], aes(x = eloquence, y = openness)) +
  geom_jitter(height = 0.01, width = 0.01, alpha = 0.5) +
  geom_smooth(aes(color = engnat))
```

### Eloquence and age

```{r eloquence-age, include=TRUE}
ggplot(dt_bigf, aes(x = age, y = eloquence)) +
  geom_jitter(height = 0.01, width = 0.3, alpha = 0.5)
```

### Openness and age

```{r openness-age, include=TRUE}
ggplot(dt_bigf, aes(x = age, y = openness)) +
  geom_jitter(height = 0.01, width = 0.1, alpha = 0.5) +
  geom_smooth()
```

### Openness and family size

```{r openness-familysize, include=TRUE}
ggplot(dt_bigf[familysize < 20,], aes(x = familysize, y = openness)) +
  geom_jitter(height = 0.01, width = 0.35, alpha = 0.5) +
  geom_smooth()
```

<!-- discrete -->

### Openness and country

```{r openness-country, include=TRUE}
ggplot(dt_bigf[(table(country) > 50)[country],], aes(x = country, y = openness)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(openness, na.rm = TRUE)])
```

### Openness and education

```{r openness-education, include=TRUE}
ggplot(dt_bigf[!is.na(education)], aes(x = education, y = openness)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(openness, na.rm = TRUE)])
```

### Openness and urban

```{r openness-urban, include=TRUE}
ggplot(dt_bigf[!is.na(urban)], aes(x = urban, y = openness)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(openness, na.rm = TRUE)])
```

### Openness and gender

```{r openness-gender, include=TRUE}
ggplot(dt_bigf[!is.na(gender),], aes(x = gender, y = openness)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(openness, na.rm = TRUE)])
```

### Openness and engnat

```{r openness-engnat, include=TRUE}
ggplot(dt_bigf, aes(x = engnat, y = openness)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(openness, na.rm = TRUE)])
```

### Eloquence and engnat

```{r eloquence-engnat, include=TRUE}
ggplot(dt_bigf, aes(x = engnat, y = eloquence)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(eloquence, na.rm = TRUE)])
```

### Eloquence and education

```{r eloquence-education, include=TRUE}
ggplot(dt_bigf[!is.na(education),], aes(x = education, y = eloquence)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(eloquence, na.rm = TRUE)])
```

### Age and education

```{r age-education, include=TRUE}
ggplot(dt_bigf[!is.na(education),], aes(x = education, y = age)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(age, na.rm = TRUE)])
```

### Openness and hand

```{r openness-hand, include=TRUE}
ggplot(dt_bigf[!is.na(hand),], aes(x = hand, y = openness)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(openness, na.rm = TRUE)])
```

### Openness and religion

```{r openness-religion, include=TRUE}
ggplot(dt_bigf[(table(religion) > 50)[religion],], aes(x = religion, y = openness)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(openness, na.rm = TRUE)])
```

### Openness and orientation

```{r openness-orientation, include=TRUE}
ggplot(dt_bigf, aes(x = orientation, y = openness)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(openness, na.rm = TRUE)])
```

### Openness and race

```{r openness-race, include=TRUE}
ggplot(dt_bigf, aes(x = race, y = openness)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(openness, na.rm = TRUE)])
```

### Openness and voted

```{r openness-voted, include=TRUE}
ggplot(dt_bigf, aes(x = voted, y = openness)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(openness, na.rm = TRUE)])

ggplot(dt_bigf[age > 20], aes(x = voted, y = openness)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(openness, na.rm = TRUE)])
```

### Openness and married

```{r openness-married, include=TRUE}
ggplot(dt_bigf, aes(x = married, y = openness)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(openness, na.rm = TRUE)])
```

<!-- technical data -->

```{r duration}
ggplot(dt_bigf[introelapse < 500,], aes(x = introelapse, y = openness)) +
  geom_jitter(height = 0.01, width = 0.00, alpha = 0.5) +
  geom_smooth()

ggplot(dt_bigf[testelapse < 1000,], aes(x = testelapse, y = openness)) +
  geom_jitter(height = 0.01, width = 0.00, alpha = 0.5) +
  geom_smooth()

ggplot(dt_bigf[surveyelapse < 1000,], aes(x = surveyelapse, y = openness)) +
  geom_jitter(height = 0.01, width = 0.00, alpha = 0.5) +
  geom_smooth()
```

```{r browser-os}
ggplot(dt_bigf, aes(x = browser, y = openness)) +
  geom_boxplot()

ggplot(dt_bigf, aes(x = os, y = openness)) +
  geom_boxplot()
```

## Modeling openness score


* TODO: try centering data
* TODO: don't forget outlier
* TODO: choose a nice reference category

```{r glm}
dt_bigf.na_omit <- na.omit(dt_bigf, cols = c("education", "gender", "urban", "engnat", "hand",
                                             "religion", "orientation", "race", "voted", "married",
                                             "familysize", "eloquence"))

m0 <- glm(cbind(hits, misses) ~ education + gender + urban + engnat + hand + religion +
          orientation + race + voted + married + familysize + eloquence,
          family = quasibinomial(), data = dt_bigf.na_omit)
summary(m0)
```

```{r lm}
m1 <- lm(openness ~ education + gender + urban + engnat + hand + religion + orientation + race +
         voted + married + familysize + eloquence, data = dt_bigf.na_omit)
summary(m1)
```

```{r plot-model-predictions}
rbind(
  data.table(pred = m0$fitted, val = dt_bigf[as.numeric(names(m0$fitted)), openness], m = "0"),
  data.table(pred = m1$fitted, val = dt_bigf[as.numeric(names(m1$fitted)), openness], m = "1")
) %>%
  ggplot(aes(x = val, y = pred, color = m)) +
  geom_point() +
  geom_smooth()
```

```{r variable-selection1}
m_const <- lm(openness ~ 1, data = dt_bigf.na_omit)

m1.sel_both <- step(m1, direction = "both", k = log(nrow(dt_bigf.na_omit)))
m1.sel_forward <- step(m1, scope = list(lower = m_const, upper = m1),
                       direction = "forward", k = log(nrow(dt_bigf.na_omit)))
m1.sel_backward <- step(m1, direction = "backward", k = log(nrow(dt_bigf.na_omit)))

summary(m1.sel_both)
summary(m1.sel_forward)
summary(m1.sel_backward)
```

```{r variable-selection2}
library(BAS)

res_bas <- bas.lm(openness ~ education + gender + urban + engnat + age + hand + religion +
                    orientation + race + voted + married + familysize + eloquence,
                  data = dt_bigf.na_omit,
                  prior = "BIC")
res_bas %$% data.table(probne0, namesx) %>%
  ggplot(aes(x = probne0, y = namesx)) +
  geom_point() +
  geom_vline(xintercept = 0.5)


m3 <- lm(openness ~ education + gender + eloquence, data = dt_bigf.na_omit)
summary(m3)

extractAIC(m1, k = log(nrow(dt_bigf.na_omit)))
extractAIC(m_const, k = log(nrow(dt_bigf.na_omit)))
extractAIC(m1.sel_both, k = log(nrow(dt_bigf.na_omit)))
extractAIC(m1.sel_forward, k = log(nrow(dt_bigf.na_omit)))
extractAIC(m1.sel_backward, k = log(nrow(dt_bigf.na_omit)))
extractAIC(m3, k = log(nrow(dt_bigf.na_omit)))
```

```{r mgcv}
library(mgcv)

m4 <- gam(formula = openness ~ education + gender + s(age, bs = "cr", k = 10) +
          s(eloquence, bs = "cr", k = 10), data = dt_bigf.na_omit, family = gaussian(), method = "REML")
summary(m4)
```

Blub.

# Conclusion

Blub.

<!-- trash -->
```{r first-attempt, eval=FALSE}
dt_bigf[, openness := rowSums(.SD) / 50, .SDcols = patterns("^O")]
0:50 / 50  # possible scores
# dt_bigf[, patterns("^[ACENOG]") := NULL]

ggplot(dt_bigf, aes(x = openness)) +
  geom_histogram(aes(y = ..density..), bins = 100, boundary = 0) +
  geom_function(fun = dnorm, args = list(mean = mean(dt_bigf$openness), sd = sd(dt_bigf$openness))) +
  geom_density(color = "red")

ggplot(dt_bigf, aes(x = openness)) +
  stat_ecdf()
```

