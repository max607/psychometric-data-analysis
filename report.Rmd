---
documentclass: report
link-citations: true
urlcolor: blue
bibliography: references.bib
linestretch: 1.5
fontsize: 12pt
output:
  bookdown::pdf_document2:
    toc: true
    toc_depth: 3
    includes:
      in_header: preamble.tex
    extra_dependencies: ["mathptmx"]
title: |
  | Assignment 29
  | Statistical Analysis of the Grit Scale Dataset \vspace{1cm}
  | ![](figures/sigillum-lmu.png){width=3cm}       \vspace{1cm}
  | ![](figures/aueb.jpg){width=9cm}               \vspace{1cm}
subtitle: |
  | Submitted to the Department of Statistics
  | of the Athens University of Economics and Business
author: |
  | By
  | Maximilian Schneider
date: "`r format(Sys.time(), '%d.%m.%Y')`"
abstract: |
  Lorem ipsum dolor sit amet, consectetur adipiscing elit.
  Integer fringilla interdum magna, at sodales ante hendrerit in.
  Ut mauris justo, sodales sed posuere id, ultrices ut ante.
  In auctor tellus nulla, nec efficitur tellus finibus id.
  Vivamus at condimentum sapien, a sodales erat.
  Nulla nec neque eu purus consequat vestibulum.
  Vestibulum placerat congue porttitor.
  In hac habitasse platea dictumst.
  In hac habitasse platea dictumst.
  Sed consectetur a quam a posuere.
  Ut elit leo, lobortis sit amet risus vel, ultrices fringilla nisl.
  Aliquam ut leo mauris.
  Suspendisse neque tellus, aliquet ac dignissim vitae, gravida sit amet elit.
  Ut eget turpis ac sem aliquet scelerisque.
  Phasellus in maximus est.
---

<style>
body {
text-align: justify}
.main-container {
  max-width: 1000px;
  margin-left: auto;
  margin-right: auto;
}
</style>

# Introduction

```{r setup, include=FALSE}
# rmarkdown settings
knitr::opts_chunk$set(fig.align = "center", out.width = '80%', include = FALSE, echo = FALSE,
                      cache = FALSE)

# packages
library(data.table)
library(purrr)
library(magrittr)
library(ggplot2); theme_set(theme_bw())

# code
source("R/prepare-data.R")
source("R/my-functions.R")
```

As part of the Data Analysis course of the Athens University of Economics and Business a dataset is to be analyzed.
This report describes the applied methods and corresponding findings.
The assigned dataset "grit scale data" originates from the study "Development and Validation of the Short Grit Scale (Grit-S)" [@duckworth2009development].

# Modeling of the openness score

## Grit Scale Dataset

### Overview

```{r data-structure}
str(dt_bigf)
summary(dt_bigf)
```

The given grit scale dataset consists of various measurements on 4270 individuals.
After preparing the dataset according to the assignment, there are 22 distinct variables.
They can be divided into 7 automatically collected technical information about the device used to complete the questionnaire, 13 personal details about the subject and two generated scores, eloquence and openness, which are described in Sections \@ref(eloquence-score) and \@ref(openness-score), respectively.

### Eloquence score

During the course of the questionnaire, participants where given a list of 16 words, three of which were not real, and tasked to mark all the words whose definitions they were sure to know.
In order to consider this in the analysis, the variables are aggregated to a single score via the sum of correct answers.
Because the questionnaire only had one box for each item, ticked meaning "I know the definition", it is assumed there are no missing observations for this set of items, which non the less could be the case, because an unchecked box could mean both.

Figure \@ref(fig:plot-eloquence) displays a barchart of the score.

```{r plot-eloquence, include=TRUE, fig.cap='(ref:plot-eloquence)'}
p <- ggplot(dt_bigf, aes(x = eloquence)) +
  geom_bar(color = "black", fill = "black") +
  scale_x_continuous(breaks = seq(0, 16, 4)) +
  labs(x = "Eloquence score", y = "Number of observations")
p
```
(ref:plot-eloquence) First figure.

```{r}
p <- ggplot(dt_bigf, aes(x = eloquence)) +
  geom_histogram(aes(y = ..density..), breaks = seq(0, 1, length = 200),
                 color = "black", fill = "white") +
  geom_density() +
  geom_function(fun = dnorm, args = dnorm_args(dt_bigf$eloquence), color = "red")

p <- ggplot(dt_bigf, aes(x = eloquence)) +
  stat_ecdf() +
  geom_function(fun = pnorm, args = dnorm_args(dt_bigf$eloquence), color = "red")
```

### Openness score

In order to asses the openness of an individual (in terms of the Big Five personality dimensions) ten questions were asked, which are to be aggregated into a single score.
Its calculation is a bit more involved compared to the eloquence score.

1) The openness items are measured on a Likert-type scale ranging from 0 (Disagree strongly) to 4 (Agree strongly).
1) There is the option to not answer the question.
1) Questions 2, 4 and 6 are formulated in a way that a higher number indicates a lower openness.
   This shows up in Figure \@ref(fig:plot-openness-items), which depicts the correlation of the individual openness items.
   For these measures $4 - x_\text{O}$ is considered.

```{r plot-openness-items, include=TRUE, fig.cap='(ref:plot-openness-items)'}
p_corr
```
(ref:plot-openness-items) YOO, holy shit

Taking into account these points, the item scores are summed up and divided by four times the number of items answered.
The histogram of the resulting score is shown in Figure \@ref(fig:).

```{r plot-openness, include=TRUE, fig.cap='(ref:plot-openness)'}
p <- ggplot(dt_bigf, aes(x = openness)) +
  geom_histogram(aes(y = ..density..), breaks = seq(0, 1, length = 200),
                 color = "black", fill = "white") +
  geom_density() +
  geom_function(fun = dnorm, args = dnorm_args(dt_bigf$openness), color = "red") +
  labs(x = "Openness score", y = "Density")
p
```
(ref:plot-openness) Second figure.

```{r}
p <- ggplot(dt_bigf, aes(x = openness)) +
  stat_ecdf() +
  geom_function(fun = pnorm, args = dnorm_args(dt_bigf$openness), color = "red")

p <- ggplot(dt_bigf, aes(sample = openness)) +
  geom_qq() +
  geom_qq_line()
```

```{r}
# TODO: remove
knitr::opts_chunk$set(eval = FALSE)
```

### Survey duration

```{r time-spent}
dt_bigf[, summary(.SD), .SDcols = patterns("elapse$")]
```

```{r plot-time, include=TRUE}
# there are some extreme values
ggplot(dt_bigf[introelapse < 3000,], aes(x = introelapse)) +
  geom_histogram(aes(y = ..density..), breaks = seq(1, 3000, length = 100),
                 color = "black", fill = "white")

dt_bigf[, lapply(.SD, function(x) {
            ind_long <- x > 3000
            list(c(sum(!ind_long), mean(x[!ind_long])), c(sum(ind_long), mean(x[ind_long])))
          })
        , .SDcols = patterns("elapse$")]
```

## Pairwise comparisons

<!-- continuous -->

### Openness and eloquence

```{r openness-eloquence, include=TRUE}
ggplot(dt_bigf[!is.na(engnat)], aes(x = eloquence, y = openness)) +
  geom_jitter(height = 0.01, width = 0.01, alpha = 0.5) +
  geom_smooth(aes(color = engnat))
```

### Eloquence and age

```{r eloquence-age, include=TRUE}
ggplot(dt_bigf, aes(x = age, y = eloquence)) +
  geom_jitter(height = 0.01, width = 0.3, alpha = 0.5)
```

### Openness and age

```{r openness-age, include=TRUE}
ggplot(dt_bigf, aes(x = age, y = openness)) +
  geom_jitter(height = 0.01, width = 0.1, alpha = 0.5) +
  geom_smooth()
```

### Openness and family size

```{r openness-familysize, include=TRUE}
ggplot(dt_bigf[familysize < 20,], aes(x = familysize, y = openness)) +
  geom_jitter(height = 0.01, width = 0.35, alpha = 0.5) +
  geom_smooth()
```

<!-- discrete -->

### Openness and country

```{r openness-country, include=TRUE}
ggplot(dt_bigf[(table(country) > 50)[country],], aes(x = country, y = openness)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(openness, na.rm = TRUE)])
```

### Openness and education

```{r openness-education, include=TRUE}
ggplot(dt_bigf[!is.na(education)], aes(x = education, y = openness)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(openness, na.rm = TRUE)])
```

### Openness and urban

```{r openness-urban, include=TRUE}
ggplot(dt_bigf[!is.na(urban)], aes(x = urban, y = openness)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(openness, na.rm = TRUE)])
```

### Openness and gender

```{r openness-gender, include=TRUE}
dt_bigf[gender %in% c("male", "female")
        , .(mean = mean(openness, na.rm = TRUE), median = median(openness, na.rm = TRUE))
        , by = "gender"]
ggplot(dt_bigf[!is.na(gender),], aes(x = gender, y = openness)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(openness, na.rm = TRUE)])
```

### Openness and engnat

```{r openness-engnat, include=TRUE}
ggplot(dt_bigf, aes(x = engnat, y = openness)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(openness, na.rm = TRUE)])
```

### Eloquence and engnat

```{r eloquence-engnat, include=TRUE}
ggplot(dt_bigf, aes(x = engnat, y = eloquence)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(eloquence, na.rm = TRUE)])
```

### Eloquence and education

```{r eloquence-education, include=TRUE}
ggplot(dt_bigf[!is.na(education),], aes(x = education, y = eloquence)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(eloquence, na.rm = TRUE)])
```

### Age and education

```{r age-education, include=TRUE}
ggplot(dt_bigf[!is.na(education),], aes(x = education, y = age)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(age, na.rm = TRUE)])
```

### Openness and hand

```{r openness-hand, include=TRUE}
ggplot(dt_bigf[!is.na(hand),], aes(x = hand, y = openness)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(openness, na.rm = TRUE)])
```

### Openness and religion

```{r openness-religion, include=TRUE}
ggplot(dt_bigf[(table(religion) > 50)[religion],], aes(x = religion, y = openness)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(openness, na.rm = TRUE)])
```

### Openness and orientation

```{r openness-orientation, include=TRUE}
ggplot(dt_bigf, aes(x = orientation, y = openness)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(openness, na.rm = TRUE)])
```

### Openness and race

```{r openness-race, include=TRUE}
ggplot(dt_bigf, aes(x = race, y = openness)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(openness, na.rm = TRUE)])
```

### Openness and voted

```{r openness-voted, include=TRUE}
ggplot(dt_bigf, aes(x = voted, y = openness)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(openness, na.rm = TRUE)])

ggplot(dt_bigf[age > 20], aes(x = voted, y = openness)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(openness, na.rm = TRUE)])
```

### Openness and married

```{r openness-married, include=TRUE}
ggplot(dt_bigf, aes(x = married, y = openness)) +
  geom_boxplot() +
  geom_hline(yintercept = dt_bigf[, median(openness, na.rm = TRUE)])
```

<!-- technical data -->

```{r duration}
ggplot(dt_bigf[introelapse < 500,], aes(x = introelapse, y = openness)) +
  geom_jitter(height = 0.01, width = 0.00, alpha = 0.5) +
  geom_smooth()

ggplot(dt_bigf[testelapse < 1000,], aes(x = testelapse, y = openness)) +
  geom_jitter(height = 0.01, width = 0.00, alpha = 0.5) +
  geom_smooth()

ggplot(dt_bigf[surveyelapse < 1000,], aes(x = surveyelapse, y = openness)) +
  geom_jitter(height = 0.01, width = 0.00, alpha = 0.5) +
  geom_smooth()
```

```{r browser-os}
ggplot(dt_bigf, aes(x = browser, y = openness)) +
  geom_boxplot()

ggplot(dt_bigf, aes(x = os, y = openness)) +
  geom_boxplot()
```

## Statistical models


* TODO: try centering data
* TODO: don't forget outlier
* TODO: choose a nice reference category
* TODO: VCL to one variable

```{r tmp1}
m_glm <- glm(cbind(hits, misses) ~ education + gender + eloquence, family = binomial(),
             data = dt_bigf)

m_lm <- lm(openness ~ education + gender + eloquence, data = dt_bigf)

library(mgcv)
m_gam <- gam(cbind(hits, misses) ~ education + gender + s(eloquence, bs = "cr", k = 10),
             data = dt_bigf, family = binomial(), optimizer = "efs")

m_lam <- gam(openness ~ education + gender + s(eloquence, bs = "cr", k = 10),
             data = dt_bigf, family = gaussian(), optimizer = "efs")

dt_bigf[used_obs(m_glm, .N), paste0("pred_", c("lm", "lam", "glm", "gam")) :=
        list(predict(m_lm),
             predict(m_lam),
             predict(m_glm, type = "response"),
             predict(m_gam, type = "response"))]

melt(dt_bigf, measure.vars = paste0("pred_", c("lm", "glm"))) %>%
  ggplot(aes(x = openness, y = value, color = variable)) +
  geom_jitter(alpha = 0.5, height = 0) +
  geom_abline(intercept = 0, slope = 1) +
  geom_smooth(se = FALSE) +
  ylim(0, 1)
```

```{r glm}
dt_bigf.na_omit <- na.omit(dt_bigf, cols = c("education", "gender", "urban", "engnat", "hand",
                                             "religion", "orientation", "race", "voted", "married",
                                             "familysize", "eloquence"))

m0 <- glm(cbind(hits, misses) ~ education + gender + urban + engnat + hand + religion +
          orientation + race + voted + married + familysize + eloquence,
          family = quasibinomial(), data = dt_bigf.na_omit)
summary(m0)
```

```{r lm}
m1 <- lm(openness ~ education + gender + urban + engnat + hand + religion + orientation + race +
         voted + married + familysize + eloquence, data = dt_bigf.na_omit)
summary(m1)
```

```{r plot-model-predictions}
rbind(
  data.table(pred = m0$fitted, val = dt_bigf[as.numeric(names(m0$fitted)), openness], m = "0"),
  data.table(pred = m1$fitted, val = dt_bigf[as.numeric(names(m1$fitted)), openness], m = "1")
) %>%
  ggplot(aes(x = val, y = pred, color = m)) +
  geom_point() +
  geom_smooth()
```

```{r correlation}
cor(dt_bigf[, -c("hits", "misses", "trials")][, .SD, .SDcols = is.numeric],
    use = "pairwise.complete.obs") %>%
  round(1) %>%
  ggcorrplot::ggcorrplot(method = "circle", type = "lower")
```

```{r variable-selection1}
m_const <- lm(openness ~ 1, data = dt_bigf.na_omit)

m1.sel_both <- step(m1, direction = "both", k = log(nrow(dt_bigf.na_omit)))
m1.sel_forward <- step(m1, scope = list(lower = m_const, upper = m1),
                       direction = "forward", k = log(nrow(dt_bigf.na_omit)))
m1.sel_backward <- step(m1, direction = "backward", k = log(nrow(dt_bigf.na_omit)))

summary(m1.sel_both)
summary(m1.sel_forward)
summary(m1.sel_backward)
```

```{r variable-selection2}
library(BAS)

res_bas <- bas.lm(openness ~ education + gender + urban + engnat + age + hand + religion +
                    orientation + race + voted + married + familysize + eloquence,
                  # data = dt_bigf.na_omit,
                  data = dt_bigf,
                  prior = "BIC")
res_bas %$% data.table(probne0, namesx) %>%
  ggplot(aes(x = probne0, y = namesx)) +
  geom_point() +
  geom_vline(xintercept = 0.5)


m3 <- lm(openness ~ education + gender + eloquence, data = dt_bigf.na_omit)
summary(m3)

extractAIC(m1, k = log(nrow(dt_bigf.na_omit)))
extractAIC(m_const, k = log(nrow(dt_bigf.na_omit)))
extractAIC(m1.sel_both, k = log(nrow(dt_bigf.na_omit)))
extractAIC(m1.sel_forward, k = log(nrow(dt_bigf.na_omit)))
extractAIC(m1.sel_backward, k = log(nrow(dt_bigf.na_omit)))
extractAIC(m3, k = log(nrow(dt_bigf.na_omit)))
```

```{r mgcv}
library(mgcv)

m4 <- gam(formula = openness ~ education + gender + s(age, bs = "cr", k = 10) +
          s(eloquence, bs = "cr", k = 10), data = dt_bigf.na_omit, family = gaussian(), method = "REML")
summary(m4)
```

Blub.

# Conclusion

Blub.

# References

<div id="refs"></div>

<!-- trash -->
```{r first-attempt, eval=FALSE}
dt_bigf[, openness := rowSums(.SD) / 50, .SDcols = patterns("^O")]
0:50 / 50  # possible scores
# dt_bigf[, patterns("^[ACENOG]") := NULL]

ggplot(dt_bigf, aes(x = openness)) +
  geom_histogram(aes(y = ..density..), bins = 100, boundary = 0) +
  geom_function(fun = dnorm, args = list(mean = mean(dt_bigf$openness), sd = sd(dt_bigf$openness))) +
  geom_density(color = "red")

ggplot(dt_bigf, aes(x = openness)) +
  stat_ecdf()
```

